name: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # æ¯æ—¥åˆå‰9æ™‚(JST)ã«å®Ÿè¡Œ
    - cron: '0 0 * * *'

jobs:
  security-audit:
    runs-on: ubuntu-latest
    
    steps:
    - name: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
      
    - name: Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        if [ -f package.json ]; then
          npm ci --only=dev
        else
          echo "package.json not found, skipping npm install"
        fi
        
    - name: npm audit ã®å®Ÿè¡Œ
      run: |
        if [ -f package.json ]; then
          npm audit --audit-level=moderate || exit_code=$?
          if [ ${exit_code:-0} -ne 0 ]; then
            echo "ğŸš¨ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
            npm audit --json > audit-results.json
            exit $exit_code
          fi
        else
          echo "package.json not found, skipping npm audit"
        fi
        
    - name: ESLint ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
      run: |
        if [ -f package.json ]; then
          npx eslint *.js --format=json --output-file=eslint-results.json || true
          echo "ESLint ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯å®Œäº†"
        fi
        
    - name: æ©Ÿå¯†æƒ…å ±ã‚¹ã‚­ãƒ£ãƒ³
      run: |
        echo "ğŸ” æ©Ÿå¯†æƒ…å ±ã®æ¤œç´¢ã‚’é–‹å§‹..."
        
        # æ©Ÿå¯†ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å®šç¾©
        patterns=(
          "api[_-]?key"
          "password"
          "secret"
          "token"
          "private[_-]?key"
          "access[_-]?key"
          "credential"
          "auth[_-]?token"
          "bearer"
          "ssh-rsa"
          "-----BEGIN"
        )
        
        found_secrets=false
        
        for pattern in "${patterns[@]}"; do
          if grep -ri --exclude-dir=.git --exclude-dir=node_modules --exclude="*.log" --exclude="*.json" "$pattern" . | grep -v -E "(test|spec|example|redacted)" | head -5; then
            found_secrets=true
            echo "âš ï¸ æ©Ÿå¯†æƒ…å ±ã®å¯èƒ½æ€§: $pattern"
          fi
        done
        
        if [ "$found_secrets" = true ]; then
          echo "ğŸš¨ æ©Ÿå¯†æƒ…å ±ãŒæ¤œå‡ºã•ã‚ŒãŸå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™"
          exit 1
        else
          echo "âœ… æ©Ÿå¯†æƒ…å ±ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ"
        fi
        
    - name: ãƒ•ã‚¡ã‚¤ãƒ«æ¨©é™ãƒã‚§ãƒƒã‚¯
      run: |
        echo "ğŸ” ãƒ•ã‚¡ã‚¤ãƒ«æ¨©é™ã®æ¤œæŸ»..."
        
        # å®Ÿè¡Œå¯èƒ½ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒã‚§ãƒƒã‚¯
        find . -type f -executable -not -path "./.git/*" -not -path "./node_modules/*" | while read file; do
          if [[ "$file" == *.js || "$file" == *.sh ]]; then
            echo "âœ… å®Ÿè¡Œæ¨©é™OK: $file"
          else
            echo "âš ï¸ ä¸è¦ãªå®Ÿè¡Œæ¨©é™: $file"
          fi
        done
        
        # æ›¸ãè¾¼ã¿æ¨©é™ã®éåº¦ãªãƒ•ã‚¡ã‚¤ãƒ«
        find . -type f -perm /o+w -not -path "./.git/*" -not -path "./node_modules/*" | while read file; do
          echo "âš ï¸ å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼æ›¸ãè¾¼ã¿æ¨©é™: $file"
        done
        
    - name: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£çµæœã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      if: failure()
      uses: actions/upload-artifact@v3
      with:
        name: security-audit-results
        path: |
          audit-results.json
          eslint-results.json
        retention-days: 30
        
    - name: çµæœã®é€šçŸ¥
      if: failure()
      run: |
        echo "ğŸš¨ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»ã§å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
        echo "è©³ç´°ã¯ Artifacts ã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„"